{% extends "base.html" %}
{% block title %}Dream Patterns{% endblock %}

{% block content %}
<!-- Previous content remains the same -->
{% endblock %}

{% block scripts %}
{% if patterns %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const chartColors = {
    primary: ['rgba(138, 43, 226, 0.7)', 'rgba(70, 130, 180, 0.7)'],
    background: ['rgba(147, 112, 219, 0.4)', 'rgba(123, 104, 238, 0.4)'],
    border: 'rgba(255, 255, 255, 0.1)'
};

const chartOptions = {
    responsive: true,
    maintainAspectRatio: true,
    plugins: {
        legend: {
            labels: {
                color: 'white',
                padding: 20,
                font: {
                    family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                }
            }
        }
    },
    scales: {
        y: {
            beginAtZero: true,
            grid: {
                color: chartColors.border
            },
            ticks: {
                color: 'white',
                font: {
                    family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                }
            }
        },
        x: {
            grid: {
                color: chartColors.border
            },
            ticks: {
                color: 'white',
                maxRotation: 45,
                minRotation: 45,
                autoSkip: true,
                maxTicksLimit: 8,
                font: {
                    family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                }
            }
        }
    }
};

function initializeChart(canvasId, loaderIdOrNull = null) {
    const canvas = document.getElementById(canvasId);
    if (loaderIdOrNull) {
        const loader = document.getElementById(loaderIdOrNull);
        setTimeout(() => {
            loader.classList.add('hidden');
            canvas.classList.remove('hidden');
        }, 1000);
    }
    return canvas.getContext('2d');
}

document.addEventListener('DOMContentLoaded', function() {
    // Mobile responsiveness helper
    function updateChartOptions(isMobile) {
        const baseOptions = {...chartOptions};
        if (isMobile) {
            baseOptions.scales.x.ticks.maxTicksLimit = 5;
        }
        return baseOptions;
    }

    const isMobile = window.innerWidth < 768;
    const mobileOptions = updateChartOptions(isMobile);

    // Mood Chart
    const moodCtx = initializeChart('moodChart', 'moodChartLoader');
    const moodData = {{ patterns.mood_patterns|tojson }};
    
    new Chart(moodCtx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(moodData),
            datasets: [{
                data: Object.values(moodData),
                backgroundColor: chartColors.primary.concat(chartColors.background),
                borderColor: chartColors.border,
                borderWidth: 2
            }]
        },
        options: {
            ...mobileOptions,
            cutout: '60%',
            plugins: {
                legend: {
                    position: isMobile ? 'bottom' : 'right',
                    labels: {
                        color: 'white',
                        padding: isMobile ? 10 : 20,
                        boxWidth: isMobile ? 12 : 20
                    }
                }
            }
        }
    });

    // Dream Frequency Chart
    const frequencyCtx = initializeChart('frequencyChart', 'frequencyChartLoader');
    const dates = Object.keys({{ patterns.dream_dates|tojson }});
    const frequency = Object.values({{ patterns.dream_dates|tojson }});
    
    new Chart(frequencyCtx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Dreams per Day',
                data: frequency,
                borderColor: chartColors.primary[0],
                backgroundColor: chartColors.background[0],
                fill: true,
                tension: 0.4
            }]
        },
        options: mobileOptions
    });

    // Theme Chart
    const themeCtx = initializeChart('themeChart', 'themeChartLoader');
    const themeData = {{ patterns.common_themes|tojson }};
    
    new Chart(themeCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(themeData),
            datasets: [{
                label: 'Occurrences',
                data: Object.values(themeData),
                backgroundColor: chartColors.primary,
                borderColor: chartColors.border,
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            ...mobileOptions,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Handle resize events
    window.addEventListener('resize', () => {
        const newIsMobile = window.innerWidth < 768;
        if (newIsMobile !== isMobile) {
            location.reload();
        }
    });
});
</script>
{% endif %}
{% endblock %}
