{% extends "base.html" %}
{% block title %}Dream Patterns{% endblock %}

{% block content %}
<div class="container mx-auto px-4">
    <div class="mb-8">
        <h2 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-300">
            <i class="heroicon heroicon-chart-bar"></i>
            Your Dream Patterns
        </h2>
        <p class="text-xl text-gray-300">Discover insights and patterns across your dream journal</p>
    </div>

    {% if patterns and patterns.dream_count > 0 %}
    <div class="space-y-6">
        <div class="dream-card">
            <h3 class="text-xl font-semibold p-4 border-b border-white/10">Mood Distribution</h3>
            <div id="moodChartContainer" class="chart-container">
                <div class="h-64 bg-gray-800/50 rounded-lg flex items-center justify-center chart-loader">
                    <div class="text-center">
                        <i class="heroicon heroicon-arrow-path animate-spin"></i>
                        <p class="text-gray-400">Loading chart...</p>
                    </div>
                </div>
                <canvas class="hidden"></canvas>
            </div>
        </div>

        <div class="dream-card">
            <h3 class="text-xl font-semibold p-4 border-b border-white/10">Dream Frequency</h3>
            <div id="frequencyChartContainer" class="chart-container">
                <div class="h-64 bg-gray-800/50 rounded-lg flex items-center justify-center chart-loader">
                    <div class="text-center">
                        <i class="heroicon heroicon-arrow-path animate-spin"></i>
                        <p class="text-gray-400">Loading chart...</p>
                    </div>
                </div>
                <canvas class="hidden"></canvas>
            </div>
        </div>

        <div class="dream-card">
            <h3 class="text-xl font-semibold p-4 border-b border-white/10">Common Themes</h3>
            <div id="themeChartContainer" class="chart-container">
                <div class="h-64 bg-gray-800/50 rounded-lg flex items-center justify-center chart-loader">
                    <div class="text-center">
                        <i class="heroicon heroicon-arrow-path animate-spin"></i>
                        <p class="text-gray-400">Loading chart...</p>
                    </div>
                </div>
                <canvas class="hidden"></canvas>
            </div>
        </div>

        <div class="dream-card">
            <h3 class="text-xl font-semibold p-4 border-b border-white/10">Pattern Analysis</h3>
            <div class="p-4">
                <div class="markdown-content">
                    {{ patterns.ai_analysis|markdown|safe }}
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="dream-card p-6">
        <div class="text-center">
            <i class="heroicon heroicon-chart-bar w-16 h-16 mx-auto mb-4 text-gray-400"></i>
            <h3 class="text-xl font-semibold mb-2">No Dream Patterns Yet</h3>
            <p class="text-gray-400 mb-4">Start logging your dreams to see patterns and insights emerge.</p>
            <a href="{{ url_for('dream_new') }}" class="dream-button">
                Log Your First Dream
            </a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{% if patterns %}
<script>
window.onerror = function(msg, url, lineNo, columnNo, error) {
    console.error('Error: ' + msg + '\nURL: ' + url + '\nLine: ' + lineNo + '\nColumn: ' + columnNo + '\nError object: ' + JSON.stringify(error));
    return false;
};

document.addEventListener('DOMContentLoaded', async function() {
    let chartScript = document.querySelector('script[src*="chart.js"]');
    if (!chartScript) {
        chartScript = document.createElement('script');
        chartScript.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        document.head.appendChild(chartScript);
    }

    try {
        await new Promise((resolve, reject) => {
            chartScript.onload = resolve;
            chartScript.onerror = reject;
        });

        const patterns = {{ patterns|tojson if patterns else 'null' }};
        if (!patterns) {
            console.warn('No pattern data available');
            return;
        }

        const chartColors = {
            primary: ['rgba(147, 51, 234, 0.7)', 'rgba(236, 72, 153, 0.7)', 'rgba(99, 102, 241, 0.7)'],
            background: ['rgba(147, 51, 234, 0.2)', 'rgba(236, 72, 153, 0.2)', 'rgba(99, 102, 241, 0.2)'],
            border: 'rgba(255, 255, 255, 0.1)'
        };

        function createChart(elementId, chartConfig) {
            const container = document.getElementById(elementId);
            if (!container) {
                throw new Error(`Container ${elementId} not found`);
            }

            const loader = container.querySelector('.chart-loader');
            const canvas = container.querySelector('canvas');
            
            if (!canvas) {
                throw new Error(`Canvas not found in ${elementId}`);
            }

            const ctx = canvas.getContext('2d');
            if (!ctx) {
                throw new Error(`Could not get 2D context for ${elementId}`);
            }

            canvas.classList.remove('hidden');
            loader.classList.add('hidden');

            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        labels: {
                            color: 'rgba(255, 255, 255, 0.8)',
                            padding: 20,
                            font: {
                                family: '-apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                            }
                        }
                    }
                },
                scales: chartConfig.type !== 'doughnut' ? {
                    y: {
                        beginAtZero: true,
                        grid: { color: chartColors.border },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.8)',
                            font: {
                                family: '-apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                            }
                        }
                    },
                    x: {
                        grid: { color: chartColors.border },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.8)',
                            maxRotation: 45,
                            minRotation: 45,
                            autoSkip: true,
                            maxTicksLimit: 8,
                            font: {
                                family: '-apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                            }
                        }
                    }
                } : {}
            };

            return new Chart(ctx, {
                ...chartConfig,
                options: {
                    ...defaultOptions,
                    ...chartConfig.options
                }
            });
        }

        // Initialize all charts
        const charts = [];

        if (patterns.mood_patterns && Object.keys(patterns.mood_patterns).length > 0) {
            charts.push(createChart('moodChartContainer', {
                type: 'doughnut',
                data: {
                    labels: Object.keys(patterns.mood_patterns),
                    datasets: [{
                        data: Object.values(patterns.mood_patterns),
                        backgroundColor: chartColors.primary,
                        borderColor: chartColors.border,
                        borderWidth: 2
                    }]
                },
                options: {
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: window.innerWidth < 768 ? 'bottom' : 'right'
                        }
                    }
                }
            }));
        }

        if (patterns.dream_dates && Object.keys(patterns.dream_dates).length > 0) {
            charts.push(createChart('frequencyChartContainer', {
                type: 'line',
                data: {
                    labels: Object.keys(patterns.dream_dates),
                    datasets: [{
                        label: 'Dreams per Day',
                        data: Object.values(patterns.dream_dates),
                        borderColor: chartColors.primary[0],
                        backgroundColor: chartColors.background[0],
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: chartColors.primary[0],
                        pointBorderColor: 'rgba(255, 255, 255, 0.8)',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                }
            }));
        }

        if (patterns.common_themes && Object.keys(patterns.common_themes).length > 0) {
            charts.push(createChart('themeChartContainer', {
                type: 'bar',
                data: {
                    labels: Object.keys(patterns.common_themes),
                    datasets: [{
                        label: 'Occurrences',
                        data: Object.values(patterns.common_themes),
                        backgroundColor: chartColors.primary,
                        borderColor: chartColors.border,
                        borderWidth: 2,
                        borderRadius: 8,
                        maxBarThickness: 40
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            }));
        }

        // Handle responsive legend position
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                charts.forEach(chart => {
                    if (chart.options?.plugins?.legend?.position) {
                        chart.options.plugins.legend.position = window.innerWidth < 768 ? 'bottom' : 'right';
                        chart.update();
                    }
                });
            }, 250);
        });

    } catch (error) {
        console.error('Error initializing charts:', error);
        document.querySelectorAll('.chart-loader').forEach(loader => {
            loader.innerHTML = `
                <div class="text-center">
                    <i class="heroicon heroicon-exclamation-triangle text-red-500 w-12 h-12 mx-auto mb-3"></i>
                    <p class="text-red-400">Error loading chart</p>
                </div>
            `;
        });
    }
});
</script>
{% endif %}
{% endblock %}
