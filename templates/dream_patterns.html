{% extends "base.html" %}
{% block title %}Dream Patterns Analysis{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card mb-4">
            <div class="card-header">
                <h2>Your Dream Patterns</h2>
                <p class="text-muted">Analysis based on your last {{ dreams|length }} dreams</p>
            </div>
            <div class="card-body">
                {% if patterns %}
                    <div id="patterns-analysis">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        No patterns could be analyzed at this time. Try logging more dreams to get better insights.
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>Dreams Analyzed</h3>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for dream in dreams %}
                    <a href="{{ url_for('dream_view', dream_id=dream.id) }}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">{{ dream.title }}</h5>
                            <small>{{ dream.date.strftime('%Y-%m-%d') }}</small>
                        </div>
                        <p class="mb-1">{{ dream.content[:100] }}...</p>
                        <small>Mood: {{ dream.mood }}</small>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const patternsData = {{ patterns|tojson|safe }};
    const patternsContainer = document.getElementById('patterns-analysis');
    
    try {
        let data = patternsData;
        // If data is a string, try to parse it
        if (typeof data === 'string') {
            data = JSON.parse(data);
        }
        
        if (!data || Object.keys(data).length === 0) {
            throw new Error('No pattern data available');
        }

        // Check for error in the response
        if (data.error) {
            throw new Error(data.error + (data.details ? ': ' + data.details : ''));
        }
        
        // Helper function to create a section
        function createSection(title, content) {
            if (!content) return '';
            return `
                <div class="mb-4">
                    <h3>${title}</h3>
                    <div class="card">
                        <div class="card-body">
                            ${typeof content === 'string' ? content : JSON.stringify(content)}
                        </div>
                    </div>
                </div>
            `;
        }

        // Build the HTML for each section
        let html = '';
        html += createSection('Common Symbols & Themes', data['Common Symbols and Themes']);
        html += createSection('Emotional Patterns', data['Emotional Patterns']);
        html += createSection('Life Events & Concerns', data['Life Events and Concerns']);
        html += createSection('Personal Growth Indicators', data['Personal Growth Indicators']);
        html += createSection('Actionable Insights', data['Actionable Insights']);

        patternsContainer.innerHTML = html || '<div class="alert alert-info">No pattern analysis available.</div>';
    } catch (e) {
        console.error('Error processing patterns data:', e);
        patternsContainer.innerHTML = '<div class="alert alert-warning">Still analyzing your dream patterns. Please try again in a moment.</div>';
    }
});
</script>
{% endblock %}
