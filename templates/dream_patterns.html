{% extends "base.html" %}
{% block title %}Dream Patterns Analysis{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card mb-4">
            <div class="card-header">
                <h2>Your Dream Patterns</h2>
                <p class="text-muted">Analysis based on your last {{ dreams|length }} dreams</p>
            </div>
            <div class="card-body">
                <div id="patterns-analysis">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>Dream Statistics</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card bg-dark">
                            <div class="card-body text-center">
                                <h4>Total Dreams</h4>
                                <p class="lead">{{ dreams|length }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-dark">
                            <div class="card-body text-center">
                                <h4>Unique Tags</h4>
                                <p class="lead" id="unique-tags">Calculating...</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-dark">
                            <div class="card-body text-center">
                                <h4>Most Common Mood</h4>
                                <p class="lead" id="common-mood">Analyzing...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>Dreams Timeline</h3>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for dream in dreams %}
                    <a href="{{ url_for('dream_view', dream_id=dream.id) }}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">{{ dream.title }}</h5>
                            <small>{{ dream.date.strftime('%Y-%m-%d') }}</small>
                        </div>
                        <p class="mb-1">{{ dream.content[:100] }}...</p>
                        <small>
                            <span class="badge bg-secondary">{{ dream.mood }}</span>
                            {% if dream.tags %}
                                {% for tag in dream.tags.split(',') %}
                                <span class="badge bg-info">{{ tag.strip() }}</span>
                                {% endfor %}
                            {% endif %}
                        </small>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const patternsContainer = document.getElementById('patterns-analysis');
    const uniqueTagsElement = document.getElementById('unique-tags');
    const commonMoodElement = document.getElementById('common-mood');
    
    function displayError(message) {
        patternsContainer.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                ${message}
            </div>`;
    }

    function createSection(title, content) {
        if (!content) return '';
        // Format content by replacing JSON escape characters and adding line breaks
        const formattedContent = content
            .replace(/\\n/g, '<br>')
            .replace(/\\"/g, '"')
            .replace(/^"|"$/g, '')
            .replace(/\\/g, '');
        
        return `
            <div class="mb-4">
                <h3 class="text-primary">${title}</h3>
                <div class="card">
                    <div class="card-body">
                        <p class="lead">${formattedContent}</p>
                    </div>
                </div>
            </div>`;
    }

    function calculateStatistics() {
        // Calculate unique tags
        const allTags = new Set();
        document.querySelectorAll('.badge.bg-info').forEach(tag => {
            allTags.add(tag.textContent.trim());
        });
        uniqueTagsElement.textContent = allTags.size;

        // Calculate most common mood
        const moodCounts = {};
        document.querySelectorAll('.badge.bg-secondary').forEach(mood => {
            const moodText = mood.textContent.trim();
            moodCounts[moodText] = (moodCounts[moodText] || 0) + 1;
        });
        const commonMood = Object.entries(moodCounts)
            .sort((a, b) => b[1] - a[1])[0];
        if (commonMood) {
            commonMoodElement.textContent = `${commonMood[0]} (${commonMood[1]}x)`;
        }
    }

    try {
        // Get the patterns data from the template
        const patternsString = '{{ patterns|tojson|safe }}';
        let patterns;
        
        try {
            patterns = JSON.parse(patternsString);
        } catch (parseError) {
            console.error('Error parsing initial JSON:', parseError);
            // Try parsing after cleaning the string
            const cleanString = patternsString
                .replace(/\\n/g, '\n')
                .replace(/\\"/g, '"')
                .replace(/^"|"$/g, '');
            patterns = JSON.parse(cleanString);
        }
        
        if (!patterns || Object.keys(patterns).length === 0) {
            throw new Error('No pattern data available');
        }

        if (patterns.error) {
            throw new Error(patterns.error);
        }

        // Build the HTML for each section
        let html = '';
        const sections = {
            'Common Symbols & Themes': patterns['Common Symbols and Themes'],
            'Emotional Patterns': patterns['Emotional Patterns'],
            'Life Events & Concerns': patterns['Life Events and Concerns'],
            'Personal Growth Indicators': patterns['Personal Growth Indicators'],
            'Actionable Insights': patterns['Actionable Insights']
        };

        for (const [title, content] of Object.entries(sections)) {
            if (content) {
                html += createSection(title, content);
            }
        }

        if (!html) {
            displayError('No pattern analysis available at this time. Please try again later.');
            return;
        }

        patternsContainer.innerHTML = html;
        calculateStatistics();

    } catch (e) {
        console.error('Error processing patterns data:', e);
        displayError('Still analyzing your dream patterns. Please try again in a moment.');
    }
});
</script>
{% endblock %}
