{% extends "base.html" %}
{% block title %}Dream Patterns{% endblock %}

{% block content %}
<div class="container mx-auto px-4">
    <div class="mb-8">
        <h2 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-300">
            Your Dream Patterns
        </h2>
        <p class="text-xl text-dream-text-primary">
            Discover insights and patterns across your dream journal
        </p>
    </div>

    {% if patterns and patterns.dream_count > 0 %}
    <div class="space-y-6">
        <!-- Mood Distribution -->
        <div class="dream-card">
            <h3 class="text-xl font-semibold p-4 border-b border-white/10">
                Mood Distribution
            </h3>
            <div class="p-6">
                <canvas id="moodChart" class="w-full max-h-[300px]"></canvas>
            </div>
        </div>

        <!-- Dream Frequency -->
        <div class="dream-card">
            <h3 class="text-xl font-semibold p-4 border-b border-white/10">
                Dream Frequency
            </h3>
            <div class="p-6">
                <canvas id="frequencyChart" class="w-full max-h-[300px]"></canvas>
            </div>
        </div>

        <!-- Common Themes -->
        <div class="dream-card">
            <h3 class="text-xl font-semibold p-4 border-b border-white/10">
                Common Themes
            </h3>
            <div class="p-6">
                <canvas id="themeChart" class="w-full max-h-[300px]"></canvas>
            </div>
        </div>

        <!-- Pattern Analysis -->
        <div class="dream-card">
            <h3 class="text-xl font-semibold p-4 border-b border-white/10">
                Pattern Analysis
            </h3>
            <div class="p-4">
                <div class="markdown-content">
                    {{ patterns.ai_analysis|markdown|safe }}
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="dream-card p-6">
        <div class="text-center">
            <svg class="h-16 w-16 mx-auto mb-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                </path>
            </svg>
            <h3 class="text-xl font-semibold mb-2">No Dream Patterns Yet</h3>
            <p class="text-gray-400 mb-4">
                Start logging your dreams to see patterns and insights emerge.
            </p>
            <a href="{{ url_for('dream_new') }}" class="dream-button">
                Log Your First Dream
            </a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{% if patterns %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Chart configuration
        const chartConfig = {
            colors: {
                primary: [
                    'rgba(147, 51, 234, 0.7)',
                    'rgba(236, 72, 153, 0.7)',
                    'rgba(99, 102, 241, 0.7)',
                    'rgba(79, 70, 229, 0.7)',
                    'rgba(244, 63, 94, 0.7)'
                ],
                border: 'rgba(255, 255, 255, 0.1)'
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        labels: {
                            color: 'rgba(255, 255, 255, 0.8)',
                            font: {
                                family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
                            }
                        },
                        position: window.innerWidth < 768 ? 'bottom' : 'right'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.8)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.8)',
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        };

        const patterns = {{ patterns|tojson|safe }};

        // Initialize charts only if Chart.js is loaded
        if (typeof Chart !== 'undefined') {
            try {
                // Mood Distribution Chart
                if (patterns.mood_patterns && Object.keys(patterns.mood_patterns).length > 0) {
                    new Chart(document.getElementById('moodChart'), {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(patterns.mood_patterns),
                            datasets: [{
                                data: Object.values(patterns.mood_patterns),
                                backgroundColor: chartConfig.colors.primary
                            }]
                        },
                        options: {
                            ...chartConfig.options,
                            cutout: '60%'
                        }
                    });
                }

                // Dream Frequency Chart
                if (patterns.dream_dates && Object.keys(patterns.dream_dates).length > 0) {
                    new Chart(document.getElementById('frequencyChart'), {
                        type: 'line',
                        data: {
                            labels: Object.keys(patterns.dream_dates),
                            datasets: [{
                                label: 'Dreams per Day',
                                data: Object.values(patterns.dream_dates),
                                borderColor: chartConfig.colors.primary[0],
                                backgroundColor: 'rgba(147, 51, 234, 0.2)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: chartConfig.options
                    });
                }

                // Theme Distribution Chart
                if (patterns.common_themes && Object.keys(patterns.common_themes).length > 0) {
                    new Chart(document.getElementById('themeChart'), {
                        type: 'bar',
                        data: {
                            labels: Object.keys(patterns.common_themes),
                            datasets: [{
                                label: 'Occurrences',
                                data: Object.values(patterns.common_themes),
                                backgroundColor: chartConfig.colors.primary
                            }]
                        },
                        options: chartConfig.options
                    });
                }
            } catch (error) {
                console.error('Error initializing charts:', error);
            }
        }
    });
</script>
{% endif %}
{% endblock %}
